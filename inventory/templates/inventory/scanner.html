{% extends 'inventory/base.html' %}

{% block title %}QR –°–∫–∞–Ω–µ—Ä{% endblock %}

{% block content %}
<div class="text-center mt-5">
    <h1>üì± –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥</h1>
    <p>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ –∫–æ–¥ –Ω–∞ –∫–æ—Ä–æ–±–∫–µ</p>
    
    <!-- HTML5 QR Code Library -->
    <div id="qr-reader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
    <div id="qr-result" class="mt-3"></div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
    function onScanSuccess(decodedText, decodedResult) {
        // decodedText = "http://127.0.0.1:8000/item/1/"
        const itemId = decodedText.split('/').slice(-2, -1)[0];
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ API
        fetch(`/api/items/${itemId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('qr-result').innerHTML = `
                    <div class="alert alert-success">
                        <h3>${data.name}</h3>
                        <p>–ú–µ—Å—Ç–æ: ${data.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                        <a href="/item/${itemId}/" class="btn btn-primary">–û—Ç–∫—Ä—ã—Ç—å</a>
                    </div>
                `;
            });
    }
    
    const html5QrCode = new Html5Qrcode("qr-reader");
    html5QrCode.start(
        { facingMode: "environment" },  // –ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞
        { fps: 10, qrbox: 250 },
        onScanSuccess
    );
</script>
{% endblock %}